{{!-- views/admin/promos/form.hbs --}}
{{#if success}}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    ✅ {{success}}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{{/if}}

{{#if error}}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    ❌ {{error}}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
{{/if}}

<h1 class="mb-4">{{#if isEdit}}Editar{{else}}Nueva{{/if}} promoción</h1>

<form
  action="/admin/promos{{#if isEdit}}/{{promo.id}}?_method=PUT{{/if}}"
  method="POST"
  class="row g-3"
>
  <div class="col-md-8">
    <label class="form-label">Nombre *</label>
    <input name="nombre" class="form-control" required value="{{promo.nombre}}">
  </div>

  <div class="col-md-4">
    <label class="form-label">Tipo</label>
    <input name="tipo" class="form-control" value="{{promo.tipo}}">
  </div>

  <div class="col-12">
    <label class="form-label">Detalle</label>
    <textarea name="detalle" class="form-control" rows="3">{{promo.detalle}}</textarea>
  </div>

  <div class="col-12">
    <label class="form-label">Regalo</label>
    <textarea name="regalo" class="form-control" rows="2">{{promo.regalo}}</textarea>
  </div>

  <div class="col-md-4">
    <label class="form-label">Presentación</label>
    <input name="presentacion" class="form-control" value="{{promo.presentacion}}">
  </div>

  <div class="col-md-4">
    <label class="form-label">Especie</label>
    <input name="especie" class="form-control" value="{{promo.especie}}">
  </div>

  <div class="col-md-4">
    <label class="form-label">Laboratorio</label>
    <input name="laboratorio" class="form-control" value="{{promo.laboratorio}}">
  </div>

  <div class="col-12">
    <label class="form-label">Productos asociados (texto de referencia)</label>
    <textarea name="productos_txt" class="form-control" rows="2" placeholder="Ej.: Doramectina 50, Pipetas gato, Línea X...">{{promo.productos_txt}}</textarea>
    <small class="text-muted">Solo informativo. La vinculación real se hace tildando productos abajo.</small>
  </div>

  <div class="col-md-4">
    <label class="form-label">Stock disponible</label>
    <input name="stock_disponible" type="number" min="0" class="form-control" value="{{promo.stock_disponible}}">
  </div>

  <div class="col-md-4">
    <label class="form-label">Vigencia desde</label>
    <input name="vigencia_desde" type="date" class="form-control" value="{{promo.vigencia_desde_iso}}">
  </div>

  <div class="col-md-4">
    <label class="form-label">Vigencia hasta</label>
    <input name="vigencia_hasta" type="date" class="form-control" value="{{promo.vigencia_hasta_iso}}">
  </div>

  <div class="col-md-2 form-check">
    <input name="vigente" class="form-check-input" type="checkbox" id="chkVigente" {{#if promo.vigente}}checked{{/if}}>
    <label class="form-check-label" for="chkVigente">Vigente</label>
  </div>

  {{#if productos}}
    <hr class="mt-4">
    <div class="col-12">
      <label class="form-label d-flex align-items-center justify-content-between">
        <span>Productos relacionados (solo activos)</span>
        <input type="text" id="filtroProductos" class="form-control form-control-sm w-auto" placeholder="Filtrar…">
      </label>

      <div class="row row-cols-2" id="productosList">
        {{#each productos}}
          <div class="form-check col mb-1" data-search="{{nombre}} {{marca}} {{presentacion}}">
            <input class="form-check-input" type="checkbox" name="productosIds" value="{{id}}" id="prod_{{id}}"
              {{#if (includes ../promo.productos id)}}checked{{/if}}>
            <label class="form-check-label" for="prod_{{id}}">
              {{nombre}} {{#if marca}}<small class="text-muted">({{marca}})</small>{{/if}}
              {{#if presentacion}}<small class="text-muted">– {{presentacion}}</small>{{/if}}
            </label>
          </div>
        {{/each}}
      </div>
      <small class="text-muted d-block mt-1">Tip: usá el filtro para buscar por nombre/marca/presentación.</small>
    </div>
  {{/if}}

  <div class="col-12 mt-3">
    <button class="btn btn-primary">Guardar</button>
    <a href="/admin/promos" class="btn btn-secondary">Volver</a>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('filtroProductos');
    const rows = [...document.querySelectorAll('#productosList [data-search]')];
    input?.addEventListener('input', () => {
      const q = (input.value || '').toLowerCase().trim();
      rows.forEach(r => {
        const hay = r.dataset.search?.toLowerCase().includes(q);
        r.style.display = hay ? '' : 'none';
      });
    });
  });
</script>
