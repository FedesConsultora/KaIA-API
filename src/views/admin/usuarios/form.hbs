{{! src/views/admin/usuarios/form.hbs }}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
      <i class="bi bi-person-badge"></i> {{#if isEdit}}Editar{{else}}Nuevo{{/if}} Usuario
    </h2>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form action="/admin/usuarios{{#if isEdit}}/{{usuario.id}}?_method=PUT{{/if}}" method="POST" class="row g-3"
        autocomplete="off">

        <h5 class="mb-3 text-primary"><i class="bi bi-info-circle"></i> Datos Personales</h5>

        <div class="col-md-6">
          <label class="form-label">Nombre / Razón Social <span class="text-danger">*</span></label>
          <input name="nombre" class="form-control" value="{{usuario.nombre}}" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Teléfono (WhatsApp)</label>
          <input name="phone" class="form-control" value="{{usuario.phone}}" autocomplete="off" autocorrect="off"
            autocapitalize="off" spellcheck="false">
          <div class="form-text">Formato internacional sin +, ej: 5491122334455</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">CUIT</label>
          <input name="cuit" class="form-control" value="{{usuario.cuit}}" autocomplete="off" autocorrect="off"
            autocapitalize="off" spellcheck="false">
        </div>

        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input name="email" type="text" class="form-control" value="{{usuario.email}}" autocomplete="new-password"
            autocorrect="off" autocapitalize="off" spellcheck="false">
          <small class="text-muted">Opcional. Deja vacío si no tiene.</small>
        </div>

        <hr class="my-4">
        <h5 class="mb-3 text-primary"><i class="bi bi-gear"></i> Configuración de Cuenta</h5>

        <div class="col-md-4">
          <label class="form-label">Rol</label>
          <select name="role" class="form-select" id="role-select">
            <option value="vet" {{#if (eq usuario.role 'vet' )}}selected{{/if}}>Veterinario / Cliente</option>
            <option value="admin" {{#if (eq usuario.role 'admin' )}}selected{{/if}}>Administrador</option>
          </select>
        </div>

        <div class="col-md-4" id="password-group"
          style="{{#if (eq usuario.role 'admin')}}display:block;{{else}}display:none;{{/if}}">
          <label class="form-label">Contraseña</label>
          <input name="password" type="password" class="form-control" placeholder="Solo para administradores">
          {{#if isEdit}}<div class="form-text">Dejar en blanco para no cambiar</div>{{/if}}
        </div>

        <hr class="my-4">
        <h5 class="mb-3 text-primary"><i class="bi bi-briefcase"></i> Asignaciones Comerciales</h5>

        <div class="col-md-6">
          <label class="form-label">Ejecutivo de Cuenta</label>
          <select name="ejecutivoId" class="form-select">
            <option value="">-- Sin asignar --</option>
            {{#each ejecutivos}}
            <option value="{{this.id}}" {{#if (eq ../usuario.ejecutivoId this.id)}}selected{{/if}}>
              {{this.nombre}}
            </option>
            {{/each}}
          </select>
          <div class="form-text">Ejecutivo responsable de este cliente.</div>
        </div>

        <div class="col-md-12">
          <label class="form-label">Condiciones Comerciales</label>
          <div class="card">
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              {{#if condiciones.length}}
              <div class="form-text mb-2">
                <i class="bi bi-info-circle"></i> Selecciona una o más condiciones para este cliente.
                Se aplicará el mejor descuento de todas las condiciones asignadas.
              </div>
              {{#each condiciones}}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="condicionesIds[]" value="{{this.id}}"
                  id="condicion{{this.id}}" {{#if (includes ../condicionesAsignadas this.id)}}checked{{/if}}>
                <label class="form-check-label" for="condicion{{this.id}}">
                  <strong>{{this.codigo}}</strong> - {{this.nombre}}
                  {{#if this.descripcion}}
                  <br><small class="text-muted">{{this.descripcion}}</small>
                  {{/if}}
                </label>
              </div>
              {{/each}}
              {{else}}
              <p class="text-muted mb-0">No hay condiciones comerciales disponibles.</p>
              {{/if}}
            </div>
          </div>
        </div>

        <div class="col-12 mt-4 d-flex gap-2 justify-content-end">
          <a class="btn btn-secondary" href="/admin/usuarios">Cancelar</a>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-save"></i> Guardar Usuario
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const roleSelect = document.getElementById('role-select');
    const passwordGroup = document.getElementById('password-group');

    roleSelect.addEventListener('change', () => {
      if (roleSelect.value === 'admin') {
        passwordGroup.style.display = 'block';
      } else {
        passwordGroup.style.display = 'none';
      }
    });
  });
</script>