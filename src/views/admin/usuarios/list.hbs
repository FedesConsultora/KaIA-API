{{!-- src/views/admin/productos/list.hbs --}}
<h1 class="mb-3">
  Productos
  <a href="/admin/productos/new" class="btn btn-success btn-sm">➕ Nuevo</a>
  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalExcel">⬆️ Importar Excel</button>
  <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalPurge">🧨 Vaciar catálogo</button>
</h1>

<form class="row gy-2 gx-2 align-items-end mb-3" method="GET" action="/admin/productos">
  <div class="col-md-4">
    <label class="form-label">Buscar</label>
    <input type="text" name="q" value="{{q}}" class="form-control" placeholder="Nombre, marca, código...">
  </div>
  <div class="col-md-2">
    <label class="form-label">Ordenar por</label>
    <select name="sort" class="form-select">
      <option value="nombre" {{#if (eq sort 'nombre')}}selected{{/if}}>Nombre</option>
      <option value="precio" {{#if (eq sort 'precio')}}selected{{/if}}>Precio</option>
      <option value="cantidad" {{#if (eq sort 'cantidad')}}selected{{/if}}>Stock</option>
      <option value="id" {{#if (eq sort 'id')}}selected{{/if}}>ID</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Dirección</label>
    <select name="dir" class="form-select">
      <option value="ASC"  {{#if (eq dir 'ASC')}}selected{{/if}}>Asc</option>
      <option value="DESC" {{#if (eq dir 'DESC')}}selected{{/if}}>Desc</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Por página</label>
    <select name="pageSize" class="form-select">
      {{#each (array 10 25 50 100 200)}}
        <option value="{{this}}" {{#if (eq ../pageSize this)}}selected{{/if}}>{{this}}</option>
      {{/each}}
    </select>
  </div>
  <div class="col-md-2">
    <button class="btn btn-secondary w-100">Aplicar</button>
  </div>
</form>

<form id="bulk-form" action="/admin/productos/bulk" method="POST" class="row g-2 align-items-center mb-3">
  <div class="col-auto">
    <select name="action" class="form-select form-select-sm" required>
      <option value="" selected>— Acción masiva —</option>
      <option value="delete">🗑 Eliminar seleccionados (esta página)</option>
      <option value="show">👁 Mostrar</option>
      <option value="hide">🙈 Ocultar</option>
      <option value="alta">⬆️ Alta</option>
      <option value="baja">⬇️ Baja</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-sm btn-secondary">Aplicar</button>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th><input type="checkbox" id="chk-all"></th>
        <th>ID</th><th>Código</th><th>Nombre</th><th>Precio</th>
        <th>Stock</th><th>Visible</th><th>De baja</th><th></th>
      </tr>
    </thead>
    <tbody>
    {{#each productos}}
      <tr>
        <td><input type="checkbox" class="chk-row" value="{{id}}"></td>
        <td>{{id}}</td>
        <td>{{id_articulo}}</td>
        <td>{{nombre}}</td>
        <td>{{#if precio}}${{precio}}{{/if}}</td>
        <td>{{cantidad}}</td>
        <td>{{#if visible}}✔{{else}}✖{{/if}}</td>
        <td>{{#if debaja}}✔{{else}}—{{/if}}</td>
        <td>
          <a class="btn btn-sm btn-primary" href="/admin/productos/{{id}}/edit">Editar</a>
          <button class="btn btn-sm btn-danger btn-confirmar-eliminar"
            data-id="{{id}}" data-nombre="{{nombre}}" data-entity="producto" data-url="/admin/productos">🗑</button>
        </td>
      </tr>
    {{/each}}
    </tbody>
  </table>
</div>

{{!-- Paginación --}}
<nav aria-label="Paginación" class="mt-3">
  <ul class="pagination">
    <li class="page-item {{#if (eq page 1)}}disabled{{/if}}">
      <a class="page-link" href="/admin/productos?page={{dec page}}&q={{q}}&sort={{sort}}&dir={{dir}}&pageSize={{pageSize}}">«</a>
    </li>
    {{#each (range 1 totalPages)}}
      <li class="page-item {{#if (eq ../page this)}}active{{/if}}">
        <a class="page-link" href="/admin/productos?page={{this}}&q={{../q}}&sort={{../sort}}&dir={{../dir}}&pageSize={{../pageSize}}">{{this}}</a>
      </li>
    {{/each}}
    <li class="page-item {{#if (eq page totalPages)}}disabled{{/if}}">
      <a class="page-link" href="/admin/productos?page={{inc page}}&q={{q}}&sort={{sort}}&dir={{dir}}&pageSize={{pageSize}}">»</a>
    </li>
  </ul>
</nav>

{{> modalConfirm }}
{{!-- ... el resto (modal Excel, modal Purge, alertas) queda igual ... --}}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const chkAll = document.getElementById('chk-all');
    const chkRows = [...document.querySelectorAll('.chk-row')];
    const bulkForm = document.getElementById('bulk-form');

    chkAll?.addEventListener('change', () => {
      chkRows.forEach(c => c.checked = chkAll.checked);
    });

    bulkForm?.addEventListener('submit', (e) => {
      const selected = chkRows.filter(c => c.checked).map(c => c.value);
      if (!selected.length) { e.preventDefault(); alert('Seleccioná al menos un producto.'); return; }
      selected.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden'; input.name = 'ids'; input.value = id;
        bulkForm.appendChild(input);
      });
    });

    // confirmación por fila
    document.addEventListener('click', (event) => {
      const btn = event.target.closest('.btn-confirmar-eliminar');
      if (!btn) return;
      const { id, nombre, entity, url } = btn.dataset;
      document.getElementById('confirm-nombre').textContent = nombre;
      document.getElementById('confirm-entity').textContent = entity || 'registro';
      document.getElementById('confirm-form').action = `${url}/${id}?_method=DELETE`;
      new bootstrap.Modal(document.getElementById('confirmModal')).show();
    });
  });
</script>
